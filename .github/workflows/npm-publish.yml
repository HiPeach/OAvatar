name: Node.js Package with Version from Date  
  
on:  
  push:  
    branches:  
      - main  
  
jobs:  
  publish-npm:  
    runs-on: ubuntu-latest  
    steps:  
      - name: 检出代码  
        uses: actions/checkout@v3  
  
      - name: 设置 Node.js 环境  
        uses: actions/setup-node@v3  
        with:  
          node-version: 16  
          registry-url: https://registry.npmjs.org/  
  
      - name: 安装依赖  
        run: |  
          sudo apt-get update  
          sudo apt-get install -y jq curl  
  
      - name: 查询包版本  
        id: check-version  
        run: |  
          PACKAGE_NAME=oavatar  
          CURRENT_DATE=$(TZ=Asia/Shanghai date +"%y.%-m.%-d")  
          VERSION_EXISTS=$(curl -s "https://registry.npmjs.org/$PACKAGE_NAME" | jq --raw-output ".versions | has(\"$CURRENT_DATE\")")  
          echo "正在查询的包：$PACKAGE_NAME@$CURRENT_DATE"  
          echo "查询结果：$VERSION_EXISTS"  
          if [ "$VERSION_EXISTS" == "true" ]; then  
            echo "今日已有提交，正在取消发布旧版本"  
            npm unpublish $PACKAGE_NAME@$CURRENT_DATE --force  
          fi  
        env:  
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}  
  
      - name: 设置包版本  
        id: set-version  
        run: |  
          echo "包版本为: $CURRENT_DATE"  
          npm version $CURRENT_DATE --no-git-tag-version  
  
      - name: 发布 NPM 包  
        run: |  
          npm publish  
        env:  
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}